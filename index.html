<script>
  // ===== MUSIC =====
  const tracks = ["music1.mp3", "music2.mp3", "music3.mp3"];
  const music = document.getElementById("bgMusic");
  const toggle = document.getElementById("musicToggle");
  const musicIcon = document.getElementById("musicIcon");
  const volume = document.getElementById("volumeSlider");

  let current = 0;

  // IMPORTANT: this tracks whether the USER wants music playing.
  // We will NOT auto-play music unless this is true.
  let userWantsMusic = true;

  function setMusicIcon(isPlaying){
    musicIcon.src = isPlaying ? "pause.png" : "start.png";
  }

  function playTrack(i){
    current = i;
    music.src = tracks[current];
    // only attempt to play if user wants music
    if (userWantsMusic) {
      music.play().then(() => setMusicIcon(true)).catch(() => {
        // autoplay can be blocked until user clicks somewhere
        setMusicIcon(false);
      });
    } else {
      setMusicIcon(false);
    }
  }

  function nextTrack(){
    // simple shuffle-ish: pick a different index
    let next = Math.floor(Math.random() * tracks.length);
    if (tracks.length > 1) {
      while (next === current) next = Math.floor(Math.random() * tracks.length);
    }
    playTrack(next);
  }

  // Initial load (may be blocked by browser until first interaction)
  window.addEventListener("load", () => {
    music.volume = Number(volume.value);
    playTrack(0);
  });

  // When a track ends, go to next (still respects userWantsMusic)
  music.addEventListener("ended", nextTrack);

  // Toggle: user intent
  toggle.addEventListener("click", () => {
    if (music.paused) {
      userWantsMusic = true;
      music.play().then(() => setMusicIcon(true)).catch(() => setMusicIcon(false));
    } else {
      userWantsMusic = false;
      music.pause();
      setMusicIcon(false);
    }
  });

  volume.addEventListener("input", () => {
    music.volume = Number(volume.value);
  });

  // ===== VIDEO PLAYERS =====
  // helper to pause all other videos
  function pauseOtherVideos(currentVideo){
    document.querySelectorAll(".p5-video").forEach(v => {
      if (v !== currentVideo) v.pause();
    });
  }

  document.querySelectorAll(".p5-player").forEach(player => {
    const video = player.querySelector(".p5-video");
    const bigPlay = player.querySelector(".p5-bigplay");
    const playBtn = player.querySelector(".p5-play");
    const progress = player.querySelector(".p5-progress");

    function setPlayIcon(isPlaying){
      // same icons you already use
      playBtn.querySelector("img").src = isPlaying ? "pause.png" : "start.png";
    }

    function showBigPlay(show){
      bigPlay.style.display = show ? "grid" : "none";
    }

    // clicking big overlay toggles play
    bigPlay.addEventListener("click", () => {
      if (video.paused) video.play();
      else video.pause();
    });

    // clicking small play button toggles play
    playBtn.addEventListener("click", () => {
      if (video.paused) video.play();
      else video.pause();
    });

    // when video starts: pause others + pause music (but don't change user intent)
    video.addEventListener("play", () => {
      pauseOtherVideos(video);

      // pause music while video is playing
      if (!music.paused) music.pause();
      setMusicIcon(false);

      setPlayIcon(true);
      showBigPlay(false);
    });

    // when video pauses: ONLY resume music if userWantsMusic is true
    video.addEventListener("pause", () => {
      setPlayIcon(false);
      showBigPlay(true);

      if (userWantsMusic) {
        music.play().then(() => setMusicIcon(true)).catch(() => setMusicIcon(false));
      }
    });

    // when video ends: show overlay + maybe resume music
    video.addEventListener("ended", () => {
      setPlayIcon(false);
      showBigPlay(true);

      if (userWantsMusic) {
        music.play().then(() => setMusicIcon(true)).catch(() => setMusicIcon(false));
      }
    });

    // progress bar setup
    video.addEventListener("loadedmetadata", () => {
      progress.min = 0;
      progress.max = Math.floor(video.duration * 1000); // ms precision
      progress.value = 0;
    });

    // update progress while playing
    video.addEventListener("timeupdate", () => {
      progress.value = Math.floor(video.currentTime * 1000);
    });

    // seeking
    progress.addEventListener("input", () => {
      video.currentTime = Number(progress.value) / 1000;
    });

    // initial UI state
    setPlayIcon(false);
    showBigPlay(true);
  });

  // ===== Autoplay fix on first user click (browser policy) =====
  // If autoplay got blocked on load, first click anywhere will start music IF userWantsMusic is true.
  document.addEventListener("click", () => {
    if (userWantsMusic && music.paused) {
      music.play().then(() => setMusicIcon(true)).catch(() => setMusicIcon(false));
    }
  }, { once: true });
</script>
